trigger:
- main

pr:
- main

variables:
  - template: .pipelines/config.variables.yml

stages:
  - template: .pipelines/build.stage.yml

  - template: .pipelines/deploy.stage.yml
    parameters:
      environmentType: ${{ variables.environmentTypeDev }}
      dependsOn: buildStage
      disabled: ${{ not(variables['isCI']) }}

  - template: .pipelines/deploy.stage.yml
    parameters:
      environmentType: ${{ variables.environmentTypeQa }}
      dependsOn: deployStage${{ variables.environmentTypeDev }}

  - stage: deployStage${{ variables.environmentTypeProd }}
    displayName: ${{ variables.environmentTypeProd }}
    dependsOn: deployStage${{ variables.environmentTypeQA }}
    jobs:
    - template: .pipelines/stagingSlot.job.yml
      parameters:
        environmentType: ${{ variables.environmentTypeProd }}

  - stage: deployProd${{ variables.environmentTypeProd }}
    displayName: ${{ variables.environmentTypeProd }}
    dependsOn: deployStage${{ variables.environmentTypeProd }}
    jobs:
    - template: .pipelines/prodSlot.job.yml
      parameters:
        environmentType: ${{ variables.environmentTypeProd }}
